import { z } from "zod";
import { APP_CONFIG } from "@shared/config";
import { AppError } from "./errors";

export const LanguageEnum = z.enum(APP_CONFIG.supportedLanguages);

export const SubmitCodeSchema = z.object({
  code: z
    .string()
    .min(1, "Code is required")
    .max(APP_CONFIG.maxCodeSizeBytes, "Code exceeds maximum allowed size"),
  language: LanguageEnum,
  userComments: z.string().max(5000).optional(),
});

export type SubmitCodeInput = z.infer<typeof SubmitCodeSchema>;

export function validateSubmission(input: unknown): SubmitCodeInput {
  const result = SubmitCodeSchema.safeParse(input);

  if (!result.success) {
    throw new AppError(
      "BAD_REQUEST",
      "Invalid submission payload",
      result.error.flatten()
    );
  }

  const { code } = result.data;

  const byteLength = Buffer.byteLength(code, "utf8");
  if (byteLength > APP_CONFIG.maxCodeSizeBytes) {
    throw new AppError(
      "BAD_REQUEST",
      `Code size exceeds limit of ${APP_CONFIG.maxCodeSizeBytes} bytes`
    );
  }

  return result.data;
}
